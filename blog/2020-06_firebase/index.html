<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <meta content=Mrn4dXO3Z_939geeswIgr2wIpspT6n7X5cX1Tjp69Ko name=google-site-verification> <base href=/ > <link href=global.css rel=stylesheet> <link href=main.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=atom-one-light.min.css rel=stylesheet> <link href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css rel=stylesheet> <link href=client/main.3380611318.css rel=stylesheet> <noscript id=sapper-head-start></noscript><title>用firebase给静态博客页面增加点赞功能-GzhiYi's blog</title><meta content=用firebase给静态博客页面增加点赞功能 name=description><meta content=firebase,like name=keywords><noscript id=sapper-head-end></noscript> </head> <body> <div id=sapper> <nav class=svelte-1wr5yce><ul class=svelte-1wr5yce> <li class=svelte-1wr5yce><a href=blog aria-current=page class=svelte-1wr5yce rel=prefetch>blog</a></ul></nav> <main class=svelte-iwmse4> <div class="svelte-iy1k43 content"><h1>用firebase给静态博客页面增加点赞功能</h1> <p class="svelte-iy1k43 desc">6/28/2020 <span class="svelte-iy1k43 label">前端</span></p> <p>想给博客增加一个点赞功能。最后，看起来就是这样：</p> <p><img align=center alt=like data-zoomable src=https://i.loli.net/2020/06/28/Ej9in7gr5uNHIJO.jpg style=width:100%></p> <p>实现这个功能要考虑几个问题：</p> <ol> <li>没有服务器，接口怎么编写部署？</li> <li>博客没有登录，数据库设计的时候怎么识别用户唯一性。</li> </ol> <h2 id=firebase>Firebase</h2> <p>对于firebase的介绍，最好是直接进入<a href=https://firebase.google.com>主站</a>开通spark版尝试。</p> <p>使用firebase，就可以很好的解决第一个问题。spark方案提供免费的空间支持，对于博客这种量级小，交互少的页面来说再适合不过了。</p> <p>如果用过tx云的云开发，就可以知道，其实概念有些相似，甚至在云函数的编写上也有几分相似。</p> <h2 id=fingerprintjs2>fingerprintjs2</h2> <p>利用<a href=https://github.com/fingerprintjs/fingerprintjs2>fingerprintjs2</a>，可以通过user agent等信息生成用户唯一的一个ID，虽然不能100%保证用户唯一性，但对于无需登录的博客而言，已经足够了。 生成指纹的主要用法：</p> <pre><code class=language-javascript>Fingerprint2.x64hash128(values.join(<span class=hljs-string>''</span>), <span class=hljs-number>31</span>)</code></pre> <h2 id=过程>过程</h2> <p>整个过程，时间大部分花在云函数执行数据库操作语法上。以下前提是开通了firebase的spark方案，开通方式直接明了就不赘述啦。</p> <h3 id=控制台>控制台</h3> <p>需要在控制台创建你的一个项目，创建好项目之后再执行下面的步骤。</p> <h3 id=函数（functions）编写>函数（functions）编写</h3> <p>相关代码可以查看：<a href=https://github.com/GzhiYi/blog-like/blob/master/functions/index.js>blog-like</a></p> <ol> <li>安装Firebase CLI工具以初始化函数仓库。</li> </ol> <pre><code class=language-bash>npm install -g firebase-tools</code></pre> <ol start=2> <li>登录</li> </ol> <pre><code class=language-bash>firebase login</code></pre> <ol start=3> <li>创建一个空目录，然后初始化这个目录，例如目录名为blog-like</li> </ol> <pre><code class=language-bash>mkdir blog-like && <span class=hljs-built_in>cd</span> blog-like && firebase init</code></pre> <p>执行init命令后会提示选择新建项目的一些规则。（以下是规则过程）</p> <p><code>q: Which Firebase CLI features do you want to set up for this folder? Press Space to select features, then Enter to confirm your choices.</code> <code>a: 选择Firestore: Deploy rules and create indexes for Firestore以及Functions: Configure and deploy Cloud Functions</code> </p> <p><code>q: Please select an option:</code> <code>a: Use an existing project，随后选择在控制台创建的项目。</code></p> <p>随后几个按enter就好了。</p> <ol start=4> <li>函数编写。</li> </ol> <p>需要两个接口，一个是新增点赞接口，路由为：<code>/newLike</code>，一个是获取点赞数据的接口，路由为：<code>/getLikes</code>。</p> <ul> <li>newLike。先判断该用户是否已经点过赞。需要存储的数据：文章标题、点赞时间、用户指纹。</li> <li>getLikes。先获取该文章点赞总数，在判断用户是否已经点过赞。</li> </ul> <p>有了以下基本代码：</p> <p>点赞数据表：</p> <pre><code class=language-json>{
    id: 用户指纹，
    likeTime：点赞时间，
    postTitle：文章标题
}</code></pre> <p>newLike，创建点赞数据：</p> <pre><code class=language-javascript>db.collection(<span class=hljs-string>'like'</span>)
  .where(<span class=hljs-string>"postTitle"</span>, <span class=hljs-string>"=="</span>, request.body.title)
  .get()
  .then(<span class=hljs-function><span class=hljs-params>res</span> =></span> {
  <span class=hljs-keyword>let</span> isLike = <span class=hljs-literal>false</span>
  <span class=hljs-keyword>try</span> {
    <span class=hljs-comment>// 判断是否已经点赞过</span>
    res.forEach(<span class=hljs-function><span class=hljs-params>doc</span> =></span> {
      <span class=hljs-keyword>if</span> (doc.id === request.body.id && !isLike) {
        isLike = <span class=hljs-literal>true</span>
      }
    })
    <span class=hljs-keyword>if</span> (!isLike) {
      <span class=hljs-keyword>let</span> docRef = db.collection(<span class=hljs-string>'like'</span>).doc(params.id);
      docRef.set({
        <span class=hljs-attr>postTitle</span>: params.title,
        <span class=hljs-attr>likeTime</span>: <span class=hljs-keyword>new</span> <span class=hljs-built_in>Date</span>().toLocaleString()
      });
      response.send({
        <span class=hljs-attr>data</span>: <span class=hljs-string>'like success!'</span>,
        <span class=hljs-attr>code</span>: <span class=hljs-number>0</span>
      })
    } <span class=hljs-keyword>else</span> {
      response.send({
        <span class=hljs-attr>data</span>: <span class=hljs-string>''</span>,
        <span class=hljs-attr>message</span>: <span class=hljs-string>'like 过啦'</span>,
        <span class=hljs-attr>code</span>: <span class=hljs-number>1</span>
      })
    }
  } <span class=hljs-keyword>catch</span> (error) {
    <span class=hljs-built_in>console</span>.log(<span class=hljs-string>'error'</span>, error)
  }
})</code></pre> <p>getLikes，获取点赞数据：</p> <pre><code class=language-javascript>db.collection(<span class=hljs-string>'like'</span>)
  .where(<span class=hljs-string>"postTitle"</span>, <span class=hljs-string>"=="</span>, title)
  .get()
  .then(<span class=hljs-function><span class=hljs-params>res</span> =></span> {
  <span class=hljs-keyword>let</span> isLike = <span class=hljs-literal>false</span>
  <span class=hljs-keyword>try</span> {
    res.forEach(<span class=hljs-function><span class=hljs-params>doc</span> =></span> {
      <span class=hljs-keyword>if</span> (doc.id === id && !isLike) {
        isLike = <span class=hljs-literal>true</span>
      }
    })
  } <span class=hljs-keyword>catch</span> (error) {
    <span class=hljs-built_in>console</span>.log(<span class=hljs-string>'error'</span>, error)
  }
  response.send({
    <span class=hljs-attr>data</span>: res.size,
    isLike,
    <span class=hljs-attr>message</span>: <span class=hljs-string>'oooooooook'</span>,
    <span class=hljs-attr>code</span>: <span class=hljs-number>0</span>
  })
})
  .catch(<span class=hljs-function><span class=hljs-params>error</span> =></span> {
  response.send({
    <span class=hljs-attr>data</span>: error,
    <span class=hljs-attr>message</span>: request.body,
    <span class=hljs-attr>code</span>: <span class=hljs-number>1</span>
  })
})</code></pre> <p>在函数编写之后，执行命令就可以部署到云端啦。</p> <pre><code class=language-bash>firebase deploy --only <span class=hljs-built_in>functions</span></code></pre> <h2 id=用户端>用户端</h2> <p>在博客页面上生成用户唯一ID后用fetch请求点赞接口就可以了。</p> <p>另外，跨域问题需要函数端用上cors处理。详细的都可以在<a href=https://github.com/GzhiYi/blog-like>仓库</a>看到。</p> <h2 id=体验>体验</h2> <p>最后说一下体验。整个开发过程比较愉快，花了点点时间查阅数据库操作语法。上线尝试访问，发现google的果然访问好慢！</p> <p>你可以点击下面clap按钮试试，如果没有，说明网络问题，unreachable。</p> </div> <div id=gitalk-container></div></main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,(function(a){return {post:{title:"2020-06\u002Ffirebase.md",path:"2020-06\u002Ffirebase",slug:"2020-06_firebase",html:"\u003Cp\u003E想给博客增加一个点赞功能。最后，看起来就是这样：\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cimg align=\"center\" style=\"width: 100%;\" data-zoomable src=\"https:\u002F\u002Fi.loli.net\u002F2020\u002F06\u002F28\u002FEj9in7gr5uNHIJO.jpg\" alt=\"like\" \u003E\u003C\u002Fp\u003E\n\u003Cp\u003E实现这个功能要考虑几个问题：\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003E没有服务器，接口怎么编写部署？\u003C\u002Fli\u003E\n\u003Cli\u003E博客没有登录，数据库设计的时候怎么识别用户唯一性。\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Ch2 id=\"firebase\"\u003EFirebase\u003C\u002Fh2\u003E\n\u003Cp\u003E对于firebase的介绍，最好是直接进入\u003Ca href=\"https:\u002F\u002Ffirebase.google.com\"\u003E主站\u003C\u002Fa\u003E开通spark版尝试。\u003C\u002Fp\u003E\n\u003Cp\u003E使用firebase，就可以很好的解决第一个问题。spark方案提供免费的空间支持，对于博客这种量级小，交互少的页面来说再适合不过了。\u003C\u002Fp\u003E\n\u003Cp\u003E如果用过tx云的云开发，就可以知道，其实概念有些相似，甚至在云函数的编写上也有几分相似。\u003C\u002Fp\u003E\n\u003Ch2 id=\"fingerprintjs2\"\u003Efingerprintjs2\u003C\u002Fh2\u003E\n\u003Cp\u003E利用\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Ffingerprintjs\u002Ffingerprintjs2\"\u003Efingerprintjs2\u003C\u002Fa\u003E，可以通过user agent等信息生成用户唯一的一个ID，虽然不能100%保证用户唯一性，但对于无需登录的博客而言，已经足够了。\n生成指纹的主要用法：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-javascript\"\u003EFingerprint2.x64hash128(values.join(\u003Cspan class=\"hljs-string\"\u003E''\u003C\u002Fspan\u003E), \u003Cspan class=\"hljs-number\"\u003E31\u003C\u002Fspan\u003E)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"过程\"\u003E过程\u003C\u002Fh2\u003E\n\u003Cp\u003E整个过程，时间大部分花在云函数执行数据库操作语法上。以下前提是开通了firebase的spark方案，开通方式直接明了就不赘述啦。\u003C\u002Fp\u003E\n\u003Ch3 id=\"控制台\"\u003E控制台\u003C\u002Fh3\u003E\n\u003Cp\u003E需要在控制台创建你的一个项目，创建好项目之后再执行下面的步骤。\u003C\u002Fp\u003E\n\u003Ch3 id=\"函数（functions）编写\"\u003E函数（functions）编写\u003C\u002Fh3\u003E\n\u003Cp\u003E相关代码可以查看：\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FGzhiYi\u002Fblog-like\u002Fblob\u002Fmaster\u002Ffunctions\u002Findex.js\"\u003Eblog-like\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003E安装Firebase CLI工具以初始化函数仓库。\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Enpm install -g firebase-tools\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Col start=\"2\"\u003E\n\u003Cli\u003E登录\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Efirebase login\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Col start=\"3\"\u003E\n\u003Cli\u003E创建一个空目录，然后初始化这个目录，例如目录名为blog-like\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Emkdir blog-like &amp;&amp; \u003Cspan class=\"hljs-built_in\"\u003Ecd\u003C\u002Fspan\u003E blog-like &amp;&amp; firebase init\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E执行init命令后会提示选择新建项目的一些规则。（以下是规则过程）\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Eq: Which Firebase CLI features do you want to set up for this folder? Press Space to select features, then Enter to confirm your choices.\u003C\u002Fcode\u003E\n\u003Ccode\u003Ea: 选择Firestore: Deploy rules and create indexes for Firestore以及Functions: Configure and deploy Cloud Functions\u003C\u002Fcode\u003E  \u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Eq: Please select an option:\u003C\u002Fcode\u003E\n\u003Ccode\u003Ea: Use an existing project，随后选择在控制台创建的项目。\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E随后几个按enter就好了。\u003C\u002Fp\u003E\n\u003Col start=\"4\"\u003E\n\u003Cli\u003E函数编写。\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cp\u003E需要两个接口，一个是新增点赞接口，路由为：\u003Ccode\u003E\u002FnewLike\u003C\u002Fcode\u003E，一个是获取点赞数据的接口，路由为：\u003Ccode\u003E\u002FgetLikes\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EnewLike。先判断该用户是否已经点过赞。需要存储的数据：文章标题、点赞时间、用户指纹。\u003C\u002Fli\u003E\n\u003Cli\u003EgetLikes。先获取该文章点赞总数，在判断用户是否已经点过赞。\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003E有了以下基本代码：\u003C\u002Fp\u003E\n\u003Cp\u003E点赞数据表：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-json\"\u003E{\n    id: 用户指纹，\n    likeTime：点赞时间，\n    postTitle：文章标题\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EnewLike，创建点赞数据：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-javascript\"\u003Edb.collection(\u003Cspan class=\"hljs-string\"\u003E'like'\u003C\u002Fspan\u003E)\n  .where(\u003Cspan class=\"hljs-string\"\u003E\"postTitle\"\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-string\"\u003E\"==\"\u003C\u002Fspan\u003E, request.body.title)\n  .get()\n  .then(\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-params\"\u003Eres\u003C\u002Fspan\u003E =&gt;\u003C\u002Fspan\u003E {\n  \u003Cspan class=\"hljs-keyword\"\u003Elet\u003C\u002Fspan\u003E isLike = \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E\n  \u003Cspan class=\"hljs-keyword\"\u003Etry\u003C\u002Fspan\u003E {\n    \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 判断是否已经点赞过\u003C\u002Fspan\u003E\n    res.forEach(\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-params\"\u003Edoc\u003C\u002Fspan\u003E =&gt;\u003C\u002Fspan\u003E {\n      \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (doc.id === request.body.id &amp;&amp; !isLike) {\n        isLike = \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E\n      }\n    })\n    \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (!isLike) {\n      \u003Cspan class=\"hljs-keyword\"\u003Elet\u003C\u002Fspan\u003E docRef = db.collection(\u003Cspan class=\"hljs-string\"\u003E'like'\u003C\u002Fspan\u003E).doc(params.id);\n      docRef.set({\n        \u003Cspan class=\"hljs-attr\"\u003EpostTitle\u003C\u002Fspan\u003E: params.title,\n        \u003Cspan class=\"hljs-attr\"\u003ElikeTime\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003EDate\u003C\u002Fspan\u003E().toLocaleString()\n      });\n      response.send({\n        \u003Cspan class=\"hljs-attr\"\u003Edata\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-string\"\u003E'like success!'\u003C\u002Fspan\u003E,\n        \u003Cspan class=\"hljs-attr\"\u003Ecode\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E\n      })\n    } \u003Cspan class=\"hljs-keyword\"\u003Eelse\u003C\u002Fspan\u003E {\n      response.send({\n        \u003Cspan class=\"hljs-attr\"\u003Edata\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-string\"\u003E''\u003C\u002Fspan\u003E,\n        \u003Cspan class=\"hljs-attr\"\u003Emessage\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-string\"\u003E'like 过啦'\u003C\u002Fspan\u003E,\n        \u003Cspan class=\"hljs-attr\"\u003Ecode\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-number\"\u003E1\u003C\u002Fspan\u003E\n      })\n    }\n  } \u003Cspan class=\"hljs-keyword\"\u003Ecatch\u003C\u002Fspan\u003E (error) {\n    \u003Cspan class=\"hljs-built_in\"\u003Econsole\u003C\u002Fspan\u003E.log(\u003Cspan class=\"hljs-string\"\u003E'error'\u003C\u002Fspan\u003E, error)\n  }\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EgetLikes，获取点赞数据：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-javascript\"\u003Edb.collection(\u003Cspan class=\"hljs-string\"\u003E'like'\u003C\u002Fspan\u003E)\n  .where(\u003Cspan class=\"hljs-string\"\u003E\"postTitle\"\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-string\"\u003E\"==\"\u003C\u002Fspan\u003E, title)\n  .get()\n  .then(\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-params\"\u003Eres\u003C\u002Fspan\u003E =&gt;\u003C\u002Fspan\u003E {\n  \u003Cspan class=\"hljs-keyword\"\u003Elet\u003C\u002Fspan\u003E isLike = \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E\n  \u003Cspan class=\"hljs-keyword\"\u003Etry\u003C\u002Fspan\u003E {\n    res.forEach(\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-params\"\u003Edoc\u003C\u002Fspan\u003E =&gt;\u003C\u002Fspan\u003E {\n      \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (doc.id === id &amp;&amp; !isLike) {\n        isLike = \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E\n      }\n    })\n  } \u003Cspan class=\"hljs-keyword\"\u003Ecatch\u003C\u002Fspan\u003E (error) {\n    \u003Cspan class=\"hljs-built_in\"\u003Econsole\u003C\u002Fspan\u003E.log(\u003Cspan class=\"hljs-string\"\u003E'error'\u003C\u002Fspan\u003E, error)\n  }\n  response.send({\n    \u003Cspan class=\"hljs-attr\"\u003Edata\u003C\u002Fspan\u003E: res.size,\n    isLike,\n    \u003Cspan class=\"hljs-attr\"\u003Emessage\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-string\"\u003E'oooooooook'\u003C\u002Fspan\u003E,\n    \u003Cspan class=\"hljs-attr\"\u003Ecode\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E\n  })\n})\n  .catch(\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-params\"\u003Eerror\u003C\u002Fspan\u003E =&gt;\u003C\u002Fspan\u003E {\n  response.send({\n    \u003Cspan class=\"hljs-attr\"\u003Edata\u003C\u002Fspan\u003E: error,\n    \u003Cspan class=\"hljs-attr\"\u003Emessage\u003C\u002Fspan\u003E: request.body,\n    \u003Cspan class=\"hljs-attr\"\u003Ecode\u003C\u002Fspan\u003E: \u003Cspan class=\"hljs-number\"\u003E1\u003C\u002Fspan\u003E\n  })\n})\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E在函数编写之后，执行命令就可以部署到云端啦。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Efirebase deploy --only \u003Cspan class=\"hljs-built_in\"\u003Efunctions\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"用户端\"\u003E用户端\u003C\u002Fh2\u003E\n\u003Cp\u003E在博客页面上生成用户唯一ID后用fetch请求点赞接口就可以了。\u003C\u002Fp\u003E\n\u003Cp\u003E另外，跨域问题需要函数端用上cors处理。详细的都可以在\u003Ca href=\"https:\u002F\u002Fgithub.com\u002FGzhiYi\u002Fblog-like\"\u003E仓库\u003C\u002Fa\u003E看到。\u003C\u002Fp\u003E\n\u003Ch2 id=\"体验\"\u003E体验\u003C\u002Fh2\u003E\n\u003Cp\u003E最后说一下体验。整个开发过程比较愉快，花了点点时间查阅数据库操作语法。上线尝试访问，发现google的果然访问好慢！\u003C\u002Fp\u003E\n\u003Cp\u003E你可以点击下面clap按钮试试，如果没有，说明网络问题，unreachable。\u003C\u002Fp\u003E\n",fmData:{attributes:{title:a,description:a,keywords:"firebase,like",labels:["前端"],date:"2020-06-28T00:00:00.000Z"},body:"想给博客增加一个点赞功能。最后，看起来就是这样：\n\n![like](https:\u002F\u002Fi.loli.net\u002F2020\u002F06\u002F28\u002FEj9in7gr5uNHIJO.jpg)\n\n实现这个功能要考虑几个问题：\n\n1. 没有服务器，接口怎么编写部署？\n2. 博客没有登录，数据库设计的时候怎么识别用户唯一性。\n\n## Firebase\n\n对于firebase的介绍，最好是直接进入[主站](https:\u002F\u002Ffirebase.google.com)开通spark版尝试。\n\n使用firebase，就可以很好的解决第一个问题。spark方案提供免费的空间支持，对于博客这种量级小，交互少的页面来说再适合不过了。\n\n如果用过tx云的云开发，就可以知道，其实概念有些相似，甚至在云函数的编写上也有几分相似。\n\n## fingerprintjs2\n\n利用[fingerprintjs2](https:\u002F\u002Fgithub.com\u002Ffingerprintjs\u002Ffingerprintjs2)，可以通过user agent等信息生成用户唯一的一个ID，虽然不能100%保证用户唯一性，但对于无需登录的博客而言，已经足够了。\n生成指纹的主要用法：\n\n```javascript\nFingerprint2.x64hash128(values.join(''), 31)\n```\n\n## 过程\n\n整个过程，时间大部分花在云函数执行数据库操作语法上。以下前提是开通了firebase的spark方案，开通方式直接明了就不赘述啦。\n\n### 控制台\n\n需要在控制台创建你的一个项目，创建好项目之后再执行下面的步骤。\n\n### 函数（functions）编写\n\n相关代码可以查看：[blog-like](https:\u002F\u002Fgithub.com\u002FGzhiYi\u002Fblog-like\u002Fblob\u002Fmaster\u002Ffunctions\u002Findex.js)\n\n1. 安装Firebase CLI工具以初始化函数仓库。\n\n```bash\nnpm install -g firebase-tools\n```\n2. 登录\n\n```bash\nfirebase login\n```\n\n3. 创建一个空目录，然后初始化这个目录，例如目录名为blog-like\n\n```bash\nmkdir blog-like && cd blog-like && firebase init\n```\n\n执行init命令后会提示选择新建项目的一些规则。（以下是规则过程）\n\n`q: Which Firebase CLI features do you want to set up for this folder? Press Space to select features, then Enter to confirm your choices.`\n`a: 选择Firestore: Deploy rules and create indexes for Firestore以及Functions: Configure and deploy Cloud Functions`  \n\n`q: Please select an option:`\n`a: Use an existing project，随后选择在控制台创建的项目。`\n\n随后几个按enter就好了。\n\n4. 函数编写。\n\n需要两个接口，一个是新增点赞接口，路由为：`\u002FnewLike`，一个是获取点赞数据的接口，路由为：`\u002FgetLikes`。\n\n - newLike。先判断该用户是否已经点过赞。需要存储的数据：文章标题、点赞时间、用户指纹。\n - getLikes。先获取该文章点赞总数，在判断用户是否已经点过赞。\n\n有了以下基本代码：\n\n点赞数据表：\n\n```json\n{\n    id: 用户指纹，\n    likeTime：点赞时间，\n    postTitle：文章标题\n}\n```\n\n\n\nnewLike，创建点赞数据：\n\n```javascript\ndb.collection('like')\n  .where(\"postTitle\", \"==\", request.body.title)\n  .get()\n  .then(res =\u003E {\n  let isLike = false\n  try {\n    \u002F\u002F 判断是否已经点赞过\n    res.forEach(doc =\u003E {\n      if (doc.id === request.body.id && !isLike) {\n        isLike = true\n      }\n    })\n    if (!isLike) {\n      let docRef = db.collection('like').doc(params.id);\n      docRef.set({\n        postTitle: params.title,\n        likeTime: new Date().toLocaleString()\n      });\n      response.send({\n        data: 'like success!',\n        code: 0\n      })\n    } else {\n      response.send({\n        data: '',\n        message: 'like 过啦',\n        code: 1\n      })\n    }\n  } catch (error) {\n    console.log('error', error)\n  }\n})\n```\n\ngetLikes，获取点赞数据：\n\n```javascript\ndb.collection('like')\n  .where(\"postTitle\", \"==\", title)\n  .get()\n  .then(res =\u003E {\n  let isLike = false\n  try {\n    res.forEach(doc =\u003E {\n      if (doc.id === id && !isLike) {\n        isLike = true\n      }\n    })\n  } catch (error) {\n    console.log('error', error)\n  }\n  response.send({\n    data: res.size,\n    isLike,\n    message: 'oooooooook',\n    code: 0\n  })\n})\n  .catch(error =\u003E {\n  response.send({\n    data: error,\n    message: request.body,\n    code: 1\n  })\n})\n```\n\n在函数编写之后，执行命令就可以部署到云端啦。\n\n```bash\nfirebase deploy --only functions\n```\n\n## 用户端\n\n在博客页面上生成用户唯一ID后用fetch请求点赞接口就可以了。\n\n另外，跨域问题需要函数端用上cors处理。详细的都可以在[仓库](https:\u002F\u002Fgithub.com\u002FGzhiYi\u002Fblog-like)看到。\n\n## 体验\n\n最后说一下体验。整个开发过程比较愉快，花了点点时间查阅数据库操作语法。上线尝试访问，发现google的果然访问好慢！\n\n你可以点击下面clap按钮试试，如果没有，说明网络问题，unreachable。",bodyBegin:9,frontmatter:"title: 用firebase给静态博客页面增加点赞功能\ndescription: 用firebase给静态博客页面增加点赞功能\nkeywords: firebase,like\nlabels: ['前端']\ndate: 2020-06-28"}}}}("用firebase给静态博客页面增加点赞功能"))]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.c7e18bc4.js"}catch(e){main="/client/legacy/client.aa8cd007.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script> <script src="https://www.googletagmanager.com/gtag/js?id=UA-170295070-1" async></script> <script> window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-170295070-1'); </script> 