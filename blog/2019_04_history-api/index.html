<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <meta content=Mrn4dXO3Z_939geeswIgr2wIpspT6n7X5cX1Tjp69Ko name=google-site-verification> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=atom-one-light.min.css rel=stylesheet> <link href=client/client-e118e612.css rel=stylesheet> <title>修改浏览器回退历史-GzhiYi's blog</title><meta content=有个需求，需要修改短链跳转到落地页后，在落地页返回的历史记录。避免出现跳转到落地页后返回还是出现短链中转的问题。 name=description data-svelte=svelte-2vncnt><meta content="浏览器,回退历史，history api,pushState,replaceState" name=keywords data-svelte=svelte-2vncnt> <link href=/client/client.505ae8a1.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-e118e612.css rel=preload as=style><link href=/client/[slug].f89c7f6c.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/config.026ad977.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.5607aec6.js rel=modulepreload as=script crossorigin=use-credentials></head> <body> <div id=sapper> <nav class=svelte-1dbd5up><ul class=svelte-1dbd5up><li class=svelte-1dbd5up><a class=svelte-1dbd5up href=.>home</a></li> <li class=svelte-1dbd5up><a class=svelte-1dbd5up href=about>about</a></li> <li class=svelte-1dbd5up><a class=svelte-1dbd5up href=blog aria-current=page rel=prefetch>blog</a></ul></nav> <main class=svelte-1uhnsl8> <div class=flex><div class=base><div class=title>修改浏览器回退历史</div> <span>2019-04-12</span></div> <div class=content><p><img align=center alt=无标题绘图 data-zoomable src=https://user-images.githubusercontent.com/21136420/56006752-c05db900-5d08-11e9-94c3-61938d3f2eeb.png style=width:100%></p> <p>有个需求，需要修改短链跳转到落地页后，在落地页返回的历史记录。避免出现跳转到落地页后返回还是出现短链中转的问题。</p> <p>要求：</p> <ol> <li>无法控制落地页的所有代码。</li> <li>回退页面可在短链内进行定义。 </li> </ol> <h3 id=history-api>History Api</h3> <p>history api提供浏览器修改历史记录功能。简单罗列下api的一些使用。</p> <pre><code class=language-javascript><span class=hljs-regexp>//</span> 返回上一个历史记录
window.history.back()
window.history.go(-<span class=hljs-number>1</span>)

<span class=hljs-regexp>//</span> 前进一个历史记录
window.history.forward()
window.history.go(<span class=hljs-number>1</span>)

<span class=hljs-regexp>//</span> 添加或者替换历史记录条目，注意这【并不会刷新页面】。
history.pushState(state, title, url);
<span class=hljs-regexp>//</span> state：网址相关的状态Object，在popstate事件触发时，会在回调函数中接收到这个对象。不需要的话可以设为null。
<span class=hljs-regexp>//</span> title：新页面的title属性，填null。
<span class=hljs-regexp>//</span> url：新的页面地址，必须必须和上一个页面处于同域，否则抛出异常。

<span class=hljs-regexp>//</span> 替换当前的历史记录，注意这【并不会刷新页面】。
history.replaceState(state, title, url);
<span class=hljs-regexp>//</span> 参数同上。
</code></pre> <h3 id=实现的思考>实现的思考</h3> <ol> <li><p>第一次尝试。既然要实现在落地页返回的历史，可不可以在短链中转页上监听一下上一页面的url，当然在跳转到落地页之前可以在落地页的url上带上参数，可以在短链中转页上通过是否带这个参数进行判断。放弃，理由是麻烦而且不稳定，可能出现难以预料的问题。</p> </li> <li><p>第二次尝试。使用历史记录api修改历史记录。要修改的页面是短链中转页的历史记录，需要替换【当前】短链中转页的历史，使得跳转到落地页到上一个历史是短链所配置到页面。</p> </li> </ol> <p>需要注意到是，历史记录不能replace或者push不同域的url。所以需要通过一个queryString进行判断。所以做法是：</p> <pre><code class=language-javascript>window.onload = <span class=hljs-keyword>function</span><span class=hljs-literal>()</span> {
      <span class=hljs-keyword>if</span> (get<span class=hljs-constructor>Param('<span class=hljs-params>backUrl</span>', <span class=hljs-params>location</span>.<span class=hljs-params>href</span>)</span>) {
        console.log('进入跳转到预定回退页')
        location.replace(get<span class=hljs-constructor>Param('<span class=hljs-params>backUrl</span>', <span class=hljs-params>location</span>.<span class=hljs-params>href</span>)</span>)
      } <span class=hljs-keyword>else</span> {
        console.log('进入跳转到落地页并改写历史')
        history.replace<span class=hljs-constructor>State(<span class=hljs-params>null</span>, <span class=hljs-params>null</span>,  <span class=hljs-string>"[域名、处理返回逻辑页面]?backUrl=https://www.baidu.com"</span>)</span>
        document.get<span class=hljs-constructor>ElementById('<span class=hljs-params>jump</span>-<span class=hljs-params>id</span>')</span>.click<span class=hljs-literal>()</span> <span class=hljs-comment>// 跳转到落地页</span>
      }
    }
<span class=hljs-comment>// getParam是获取链接qs参数的函数。</span>
</code></pre> </div> </div></main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{title:"修改浏览器回退历史",description:"有个需求，需要修改短链跳转到落地页后，在落地页返回的历史记录。避免出现跳转到落地页后返回还是出现短链中转的问题。",keywords:"浏览器,回退历史，history api,pushState,replaceState",labels:["前端"],date:"2019-04-12",path:"2019\u002F04\u002Fhistory-api.md",slug:"2019_04_history-api",html:"\u003Cp\u003E\u003Cimg align=\"center\" style=\"width: 100%;\" data-zoomable src=\"https:\u002F\u002Fuser-images.githubusercontent.com\u002F21136420\u002F56006752-c05db900-5d08-11e9-94c3-61938d3f2eeb.png\" alt=\"无标题绘图\" \u003E\u003C\u002Fp\u003E\n\u003Cp\u003E有个需求，需要修改短链跳转到落地页后，在落地页返回的历史记录。避免出现跳转到落地页后返回还是出现短链中转的问题。\u003C\u002Fp\u003E\n\u003Cp\u003E要求：\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003E无法控制落地页的所有代码。\u003C\u002Fli\u003E\n\u003Cli\u003E回退页面可在短链内进行定义。 \u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Ch3 id=\"history-api\"\u003EHistory Api\u003C\u002Fh3\u003E\n\u003Cp\u003Ehistory api提供浏览器修改历史记录功能。简单罗列下api的一些使用。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-javascript\"\u003E\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 返回上一个历史记录\nwindow.history.back()\nwindow.history.go(-\u003Cspan class=\"hljs-number\"\u003E1\u003C\u002Fspan\u003E)\n\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 前进一个历史记录\nwindow.history.forward()\nwindow.history.go(\u003Cspan class=\"hljs-number\"\u003E1\u003C\u002Fspan\u003E)\n\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 添加或者替换历史记录条目，注意这【并不会刷新页面】。\nhistory.pushState(state, title, url);\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E state：网址相关的状态Object，在popstate事件触发时，会在回调函数中接收到这个对象。不需要的话可以设为null。\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E title：新页面的title属性，填null。\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E url：新的页面地址，必须必须和上一个页面处于同域，否则抛出异常。\n\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 替换当前的历史记录，注意这【并不会刷新页面】。\nhistory.replaceState(state, title, url);\n\u003Cspan class=\"hljs-regexp\"\u003E\u002F\u002F\u003C\u002Fspan\u003E 参数同上。\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"实现的思考\"\u003E实现的思考\u003C\u002Fh3\u003E\n\u003Col\u003E\n\u003Cli\u003E\u003Cp\u003E第一次尝试。既然要实现在落地页返回的历史，可不可以在短链中转页上监听一下上一页面的url，当然在跳转到落地页之前可以在落地页的url上带上参数，可以在短链中转页上通过是否带这个参数进行判断。放弃，理由是麻烦而且不稳定，可能出现难以预料的问题。\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E第二次尝试。使用历史记录api修改历史记录。要修改的页面是短链中转页的历史记录，需要替换【当前】短链中转页的历史，使得跳转到落地页到上一个历史是短链所配置到页面。\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cp\u003E需要注意到是，历史记录不能replace或者push不同域的url。所以需要通过一个queryString进行判断。所以做法是：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-javascript\"\u003Ewindow.onload = \u003Cspan class=\"hljs-keyword\"\u003Efunction\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-literal\"\u003E()\u003C\u002Fspan\u003E {\n      \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (get\u003Cspan class=\"hljs-constructor\"\u003EParam(&#x27;\u003Cspan class=\"hljs-params\"\u003EbackUrl\u003C\u002Fspan\u003E&#x27;, \u003Cspan class=\"hljs-params\"\u003Elocation\u003C\u002Fspan\u003E.\u003Cspan class=\"hljs-params\"\u003Ehref\u003C\u002Fspan\u003E)\u003C\u002Fspan\u003E) {\n        console.log(&#x27;进入跳转到预定回退页&#x27;)\n        location.replace(get\u003Cspan class=\"hljs-constructor\"\u003EParam(&#x27;\u003Cspan class=\"hljs-params\"\u003EbackUrl\u003C\u002Fspan\u003E&#x27;, \u003Cspan class=\"hljs-params\"\u003Elocation\u003C\u002Fspan\u003E.\u003Cspan class=\"hljs-params\"\u003Ehref\u003C\u002Fspan\u003E)\u003C\u002Fspan\u003E)\n      } \u003Cspan class=\"hljs-keyword\"\u003Eelse\u003C\u002Fspan\u003E {\n        console.log(&#x27;进入跳转到落地页并改写历史&#x27;)\n        history.replace\u003Cspan class=\"hljs-constructor\"\u003EState(\u003Cspan class=\"hljs-params\"\u003Enull\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-params\"\u003Enull\u003C\u002Fspan\u003E,  \u003Cspan class=\"hljs-string\"\u003E&quot;[域名、处理返回逻辑页面]?backUrl=https:\u002F\u002Fwww.baidu.com&quot;\u003C\u002Fspan\u003E)\u003C\u002Fspan\u003E\n        document.get\u003Cspan class=\"hljs-constructor\"\u003EElementById(&#x27;\u003Cspan class=\"hljs-params\"\u003Ejump\u003C\u002Fspan\u003E-\u003Cspan class=\"hljs-params\"\u003Eid\u003C\u002Fspan\u003E&#x27;)\u003C\u002Fspan\u003E.click\u003Cspan class=\"hljs-literal\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 跳转到落地页\u003C\u002Fspan\u003E\n      }\n    }\n\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F getParam是获取链接qs参数的函数。\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.505ae8a1.js"}catch(e){main="/client/legacy/client.86ff3711.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.4.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-170295070-1"></script> <script> window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-170295070-1'); </script> 