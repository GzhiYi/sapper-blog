{"title":"2018-10/mp-countdown.md","path":"2018-10/mp-countdown","slug":"2018-10_mp-countdown","html":"<h3 id=\"写在前\">写在前</h3>\n<p>最近由于业务需要，需要做一个倒计时的小插件，想想自己在很久以前用JavaScript写过，操作dom，很快就可以修改对应的数字了。现在换到小程序后，主要的还是去更改data的值，进而修改对应的图片。  </p>\n<!--more-->\n\n<h3 id=\"效果\">效果</h3>\n<p><img align=\"center\" style=\"width: 100%;\" data-zoomable src=\"https://images.vrm.cn/2018/11/22/微信截图_20181122151328.png\" alt=\"counter\" >\n具体：  </p>\n<ul>\n<li>精度为天时分秒</li>\n<li>初始时间可以从接口获取</li>\n</ul>\n<h3 id=\"代码\">代码</h3>\n<pre><code class=\"language-html\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">view</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"counter\"</span>&gt;</span>\n    距离活动结束仅剩\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.dayBegin}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.dayEnd}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    天\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.hourBegin}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.hourEnd}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    时\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.minuteBegin}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.minuteEnd}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    分\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.secondBegin}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">\"showPicture\"</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">\"clock\"</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">\"widthFix\"</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">\"../../src/images/clock/num{{count.secondEnd}}.png\"</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    秒\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">view</span>&gt;</span></code></pre>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// 初始值</span>\n<span class=\"hljs-attr\">timer</span>: <span class=\"hljs-literal\">null</span>,\n<span class=\"hljs-attr\">data</span>: {\n  <span class=\"hljs-attr\">count</span>: {\n    <span class=\"hljs-attr\">expireDate</span>: <span class=\"hljs-number\">172800</span>, <span class=\"hljs-comment\">// s</span>\n    <span class=\"hljs-attr\">dayBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">dayEnd</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">hourBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">hourEnd</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">minuteBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">minuteEnd</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">secondBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">secondEnd</span>: <span class=\"hljs-number\">0</span>\n  }\n}\n\n<span class=\"hljs-comment\">// 接口回调处</span>\n<span class=\"hljs-keyword\">let</span> { count } = <span class=\"hljs-keyword\">this</span>.data\ndelele count[<span class=\"hljs-string\">`expireDate`</span>] <span class=\"hljs-comment\">// 删除原count中的expireDate</span>\n<span class=\"hljs-keyword\">this</span>.setData({\n  ...count,\n  <span class=\"hljs-attr\">expireDate</span>: newExpireDate\n})\n<span class=\"hljs-keyword\">this</span>.timer = setInterval(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n  <span class=\"hljs-keyword\">let</span> expireDate = <span class=\"hljs-keyword\">this</span>.data.count.expireDate - <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-keyword\">this</span>.setData({\n    <span class=\"hljs-attr\">count</span>: {\n      <span class=\"hljs-attr\">dayBegin</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">dayEnd</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">1</span>],\n      <span class=\"hljs-attr\">hourBegin</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">1</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">hourEnd</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">1</span>][<span class=\"hljs-number\">1</span>],\n      <span class=\"hljs-attr\">minuteBegin</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">2</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">minuteEnd</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">2</span>][<span class=\"hljs-number\">1</span>],\n      <span class=\"hljs-attr\">secondBegin</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">3</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">secondEnd</span>: <span class=\"hljs-keyword\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">3</span>][<span class=\"hljs-number\">1</span>],\n      expireDate,\n    }\n  })\n}, <span class=\"hljs-number\">1000</span>)\n\n<span class=\"hljs-comment\">/**\n * 时间转化函数，时间戳入参为秒\n*/</span>\n<span class=\"hljs-attr\">convertTime</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">sec</span>) </span>{\n  <span class=\"hljs-keyword\">let</span> time\n  <span class=\"hljs-keyword\">if</span> (sec &gt; <span class=\"hljs-number\">-1</span>) {\n    <span class=\"hljs-keyword\">let</span> hour = <span class=\"hljs-built_in\">Math</span>.floor(sec / <span class=\"hljs-number\">3600</span>)\n    <span class=\"hljs-keyword\">let</span> min = <span class=\"hljs-built_in\">Math</span>.floor(sec / <span class=\"hljs-number\">60</span>) % <span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> second = sec % <span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> day = <span class=\"hljs-built_in\">parseInt</span>(hour / <span class=\"hljs-number\">24</span>)\n    hour = hour - <span class=\"hljs-number\">24</span> * day\n    hour = hour &lt; <span class=\"hljs-number\">10</span> ? <span class=\"hljs-string\">`0<span class=\"hljs-subst\">${hour}</span>`</span> : hour\n    time = day &lt; <span class=\"hljs-number\">10</span> ? <span class=\"hljs-string\">`0<span class=\"hljs-subst\">${day}</span>:<span class=\"hljs-subst\">${hour}</span>:`</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">${day}</span>:<span class=\"hljs-subst\">${hour}</span>:`</span>\n    <span class=\"hljs-keyword\">if</span> (min &lt; <span class=\"hljs-number\">10</span>) {\n      time += <span class=\"hljs-string\">\"0\"</span>\n    }\n    time += min + <span class=\"hljs-string\">\":\"</span>;\n    <span class=\"hljs-keyword\">if</span> (second &lt; <span class=\"hljs-number\">10</span>) {\n      time += <span class=\"hljs-string\">\"0\"</span>\n    }\n    time += second\n    <span class=\"hljs-keyword\">return</span> time.split(<span class=\"hljs-string\">':'</span>) <span class=\"hljs-comment\">// 返回一个包含天时分秒的数组</span>\n  }\n}\n<span class=\"hljs-comment\">// 最后不要忘记在周期销毁处清空计时器</span>\n<span class=\"hljs-attr\">onUnload</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>{\n  clearInterval(<span class=\"hljs-keyword\">this</span>.timer)\n}</code></pre>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// 时间转 **前的函数</span>\n  <span class=\"hljs-attr\">getDateDiff</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">dateTimeStamp</span>)</span>{\n    <span class=\"hljs-keyword\">let</span> result = <span class=\"hljs-string\">''</span>\n    <span class=\"hljs-keyword\">let</span> minute = <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> hour = minute * <span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> day = hour * <span class=\"hljs-number\">24</span>\n    <span class=\"hljs-keyword\">let</span> halfamonth = day * <span class=\"hljs-number\">15</span>\n    <span class=\"hljs-keyword\">let</span> month = day * <span class=\"hljs-number\">30</span>\n    <span class=\"hljs-keyword\">let</span> now = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Date</span>().getTime()\n    <span class=\"hljs-keyword\">let</span> diffValue = now - dateTimeStamp\n    <span class=\"hljs-keyword\">if</span>(diffValue &lt; <span class=\"hljs-number\">0</span>) { <span class=\"hljs-keyword\">return</span>; }\n    <span class=\"hljs-keyword\">let</span> monthC = diffValue / month\n      <span class=\"hljs-keyword\">let</span> weekC = diffValue / (<span class=\"hljs-number\">7</span> * day)\n      <span class=\"hljs-keyword\">let</span> dayC = diffValue / day\n      <span class=\"hljs-keyword\">let</span> hourC = diffValue / hour\n      <span class=\"hljs-keyword\">let</span> minC = diffValue / minute\n      <span class=\"hljs-keyword\">if</span>(monthC&gt;= <span class=\"hljs-number\">1</span>){\n    result = <span class=\"hljs-string\">\"\"</span> + <span class=\"hljs-built_in\">parseInt</span>(monthC) + <span class=\"hljs-string\">\"月前\"</span>\n    }\n      <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (weekC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">\"\"</span> + <span class=\"hljs-built_in\">parseInt</span>(weekC) + <span class=\"hljs-string\">\"周前\"</span>\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (dayC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">\"\"</span> + <span class=\"hljs-built_in\">parseInt</span>(dayC) + <span class=\"hljs-string\">\"天前\"</span>\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (hourC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">\"\"</span> + <span class=\"hljs-built_in\">parseInt</span>(hourC) + <span class=\"hljs-string\">\"小时前\"</span>\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (minC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">\"\"</span> + <span class=\"hljs-built_in\">parseInt</span>(minC) + <span class=\"hljs-string\">\"分钟前\"</span>\n    } <span class=\"hljs-keyword\">else</span>\n      result = <span class=\"hljs-string\">\"刚刚\"</span>\n    <span class=\"hljs-keyword\">return</span> result\n  },</code></pre>\n<h3 id=\"最后\">最后</h3>\n<p>相关思路适用于所有mvvm框架。</p>\n","fmData":{"attributes":{"title":"用小程序做个动态倒计时","description":"最近由于业务需要，需要做一个倒计时的小插件，想想自己在很久以前用JavaScript写过，操作dom，很快就可以修改对应的数字了。现在换到小程序后，主要的还是去更改data的值，进而修改对应的图片。","keywords":"小程序,倒计时,编写","labels":["小程序"],"date":"2018-10-15T00:00:00.000Z"},"body":"### 写在前\n\n最近由于业务需要，需要做一个倒计时的小插件，想想自己在很久以前用JavaScript写过，操作dom，很快就可以修改对应的数字了。现在换到小程序后，主要的还是去更改data的值，进而修改对应的图片。  \n\n<!--more-->\n\n### 效果\n\n![counter](https://images.vrm.cn/2018/11/22/微信截图_20181122151328.png)\n具体：  \n\n- 精度为天时分秒\n- 初始时间可以从接口获取\n\n### 代码\n```html\n  <view class=\"counter\">\n    距离活动结束仅剩\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.dayBegin}}.png\"></image>\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.dayEnd}}.png\"></image>\n    天\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.hourBegin}}.png\"></image>\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.hourEnd}}.png\"></image>\n    时\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.minuteBegin}}.png\"></image>\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.minuteEnd}}.png\"></image>\n    分\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.secondBegin}}.png\"></image>\n    <image bindload=\"showPicture\" class=\"clock\" mode=\"widthFix\" src=\"../../src/images/clock/num{{count.secondEnd}}.png\"></image>\n    秒\n  </view>\n```\n```javascript\n// 初始值\ntimer: null,\ndata: {\n  count: {\n    expireDate: 172800, // s\n    dayBegin: 0,\n    dayEnd: 0,\n    hourBegin: 0,\n    hourEnd: 0,\n    minuteBegin: 0,\n    minuteEnd: 0,\n    secondBegin: 0,\n    secondEnd: 0\n  }\n}\n\n// 接口回调处\nlet { count } = this.data\ndelele count[`expireDate`] // 删除原count中的expireDate\nthis.setData({\n  ...count,\n  expireDate: newExpireDate\n})\nthis.timer = setInterval(function() {\n  let expireDate = this.data.count.expireDate - 1\n  this.setData({\n    count: {\n      dayBegin: this.convertTime(expireDate)[0][0],\n      dayEnd: this.convertTime(expireDate)[0][1],\n      hourBegin: this.convertTime(expireDate)[1][0],\n      hourEnd: this.convertTime(expireDate)[1][1],\n      minuteBegin: this.convertTime(expireDate)[2][0],\n      minuteEnd: this.convertTime(expireDate)[2][1],\n      secondBegin: this.convertTime(expireDate)[3][0],\n      secondEnd: this.convertTime(expireDate)[3][1],\n      expireDate,\n    }\n  })\n}, 1000)\n\n/**\n * 时间转化函数，时间戳入参为秒\n*/\nconvertTime: function (sec) {\n  let time\n  if (sec > -1) {\n    let hour = Math.floor(sec / 3600)\n    let min = Math.floor(sec / 60) % 60\n    let second = sec % 60\n    let day = parseInt(hour / 24)\n    hour = hour - 24 * day\n    hour = hour < 10 ? `0${hour}` : hour\n    time = day < 10 ? `0${day}:${hour}:`: `${day}:${hour}:`\n    if (min < 10) {\n      time += \"0\"\n    }\n    time += min + \":\";\n    if (second < 10) {\n      time += \"0\"\n    }\n    time += second\n    return time.split(':') // 返回一个包含天时分秒的数组\n  }\n}\n// 最后不要忘记在周期销毁处清空计时器\nonUnload: function () {\n  clearInterval(this.timer)\n}\n```\n```javascript\n// 时间转 **前的函数\n  getDateDiff: function(dateTimeStamp){\n    let result = ''\n    let minute = 1000 * 60\n    let hour = minute * 60\n    let day = hour * 24\n    let halfamonth = day * 15\n    let month = day * 30\n    let now = new Date().getTime()\n    let diffValue = now - dateTimeStamp\n    if(diffValue < 0) { return; }\n    let monthC = diffValue / month\n      let weekC = diffValue / (7 * day)\n      let dayC = diffValue / day\n      let hourC = diffValue / hour\n      let minC = diffValue / minute\n      if(monthC>= 1){\n    result = \"\" + parseInt(monthC) + \"月前\"\n    }\n      else if (weekC >= 1) {\n      result = \"\" + parseInt(weekC) + \"周前\"\n    }\n    else if (dayC >= 1) {\n      result = \"\" + parseInt(dayC) + \"天前\"\n    }\n    else if (hourC >= 1) {\n      result = \"\" + parseInt(hourC) + \"小时前\"\n    }\n    else if (minC >= 1) {\n      result = \"\" + parseInt(minC) + \"分钟前\"\n    } else\n      result = \"刚刚\"\n    return result\n  },\n```\n### 最后\n相关思路适用于所有mvvm框架。","bodyBegin":9,"frontmatter":"title: 用小程序做个动态倒计时 \ndescription: 最近由于业务需要，需要做一个倒计时的小插件，想想自己在很久以前用JavaScript写过，操作dom，很快就可以修改对应的数字了。现在换到小程序后，主要的还是去更改data的值，进而修改对应的图片。 \nkeywords: 小程序,倒计时,编写\nlabels: ['小程序']\ndate: 2018-10-15"}}