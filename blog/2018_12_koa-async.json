{"title":"koa异步写文件遇到的小问题","description":"最近用koa写个微信小程序二维码生成接口，出现了一个小坑：由于小程序二维码生成接口返回的是二进制流，需要通过fs操作生成图片返回给前端下载。期间反复出现下载文件大小为0（零 / 大小未知）的情况。","keywords":"koa,async,file","labels":["前端"],"date":"2018-12-13","path":"2018/12/koa-async.md","slug":"2018_12_koa-async","html":"<p><img align=\"center\" style=\"width: 100%;\" data-zoomable src=\"https://github.com/koajs/koa/raw/master/docs/logo.png\" alt=\"koa\" >\n最近用koa写个微信小程序二维码生成接口，出现了一个小坑：由于小程序二维码生成接口返回的是二进制流，需要通过fs操作生成图片返回给前端下载。期间反复出现下载文件大小为0（零 / 大小未知）的情况。  </p>\n<p><strong>主要生成二维码代码如下</strong></p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// 其余代码省略</span>\n<span class=\"hljs-keyword\">const</span> writeS = fs.createWriteStream(<span class=\"hljs-string\">&#x27;qrcode.png&#x27;</span>)\n<span class=\"hljs-keyword\">await</span> request(<span class=\"hljs-comment\">{\n  uri: `https://api.weixin.qq.com/wxa/getwxacode?access_token=${token}</span>`,\n  <span class=\"hljs-function\"><span class=\"hljs-keyword\">method</span>:</span> <span class=\"hljs-string\">&#x27;post&#x27;</span>,\n  body: data,\n  json: <span class=\"hljs-keyword\">true</span>\n}).pipe(writeS)\n<span class=\"hljs-comment\">// 其余代码省略</span>\n</code></pre>\n<p>需要有个先后顺序问题，必须先等到文件写完后才能进行图片下载接口调用。处理方法是在前端调用生成二维码的接口，而接口的操作需要有个等待过程，即要在<code>createWriteStream</code>结束后<strong>生成二维码接口</strong>才返回数据。  </p>\n<p>前端在接收到<strong>生成二维码接口</strong>返回数据后才调用下载二维码接口。  </p>\n<p>koa端等待写文件结束后返回，这里koa要用promise在callback后触发返回数据：</p>\n<pre><code class=\"language-javascript\"> ctx.body = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">(resolve, reject)</span> =&gt;</span> {\n    writeS.<span class=\"hljs-literal\">on</span>(<span class=\"hljs-string\">&#x27;finish&#x27;</span>, function () {\n      resolve({\n        code: <span class=\"hljs-number\">1</span>\n      })\n    })\n  })\n</code></pre>\n<p>前端监听操作：</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-title\">if</span> (res.<span class=\"hljs-class\"><span class=\"hljs-keyword\">data</span>.code === 1) {\n  <span class=\"hljs-title\">window</span>.<span class=\"hljs-title\">open</span>(&#x27;图片下载地址&#x27;)\n}</span>\n</code></pre>\n<p>具体接口代码（<a target='_blank'  href=\"https://github.com/GzhiYi/wxqrcode-generater/blob/master/index.js\">查看</a>）</p>\n"}