{"title":"用小程序做个动态倒计时","description":"最近由于业务需要，需要做一个倒计时的小插件，想想自己在很久以前用JavaScript写过，操作dom，很快就可以修改对应的数字了。现在换到小程序后，主要的还是去更改data的值，进而修改对应的图片。","keywords":"小程序,倒计时,编写","labels":["小程序"],"date":"2018-10-15","path":"2018/10/mp-countdown.md","slug":"2018_10_mp-countdown","html":"<h3 id=\"写在前\">写在前</h3>\n<p>最近由于业务需要，需要做一个倒计时的小插件，想想自己在很久以前用JavaScript写过，操作dom，很快就可以修改对应的数字了。现在换到小程序后，主要的还是去更改data的值，进而修改对应的图片。  </p>\n<!--more-->\n\n<h3 id=\"效果\">效果</h3>\n<p><img align=\"center\" style=\"width: 100%;margin-bottom: 20px;border-radius: 8px;background: #f8fdf3;\" data-zoomable src=\"https://images.vrm.cn/2018/11/22/微信截图_20181122151328.png\" alt=\"counter\" >\n具体：  </p>\n<ul>\n<li>精度为天时分秒</li>\n<li>初始时间可以从接口获取</li>\n</ul>\n<h3 id=\"代码\">代码</h3>\n<pre><code class=\"language-html\"><span class=\"xml\">  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">view</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;counter&quot;</span>&gt;</span>\n    距离活动结束仅剩\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.dayBegin</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.dayEnd</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    天\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.hourBegin</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.hourEnd</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    时\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.minuteBegin</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.minuteEnd</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    分\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.secondBegin</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">image</span> <span class=\"hljs-attr\">bindload</span>=<span class=\"hljs-string\">&quot;showPicture&quot;</span> <span class=\"hljs-attr\">class</span>=<span class=\"hljs-string\">&quot;clock&quot;</span> <span class=\"hljs-attr\">mode</span>=<span class=\"hljs-string\">&quot;widthFix&quot;</span> <span class=\"hljs-attr\">src</span>=<span class=\"hljs-string\">&quot;../../src/images/clock/num</span></span></span><span class=\"hljs-template-variable\">{{<span class=\"hljs-name\">count.secondEnd</span>}}</span><span class=\"xml\"><span class=\"hljs-tag\"><span class=\"hljs-string\">.png&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">image</span>&gt;</span>\n    秒\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">view</span>&gt;</span></span>\n</code></pre>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// 初始值</span>\n<span class=\"hljs-attr\">timer</span>: <span class=\"hljs-literal\">null</span>,\n<span class=\"hljs-attr\">data</span>: {\n  <span class=\"hljs-attr\">count</span>: {\n    <span class=\"hljs-attr\">expireDate</span>: <span class=\"hljs-number\">172800</span>, <span class=\"hljs-comment\">// s</span>\n    <span class=\"hljs-attr\">dayBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">dayEnd</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">hourBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">hourEnd</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">minuteBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">minuteEnd</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">secondBegin</span>: <span class=\"hljs-number\">0</span>,\n    <span class=\"hljs-attr\">secondEnd</span>: <span class=\"hljs-number\">0</span>\n  }\n}\n\n<span class=\"hljs-comment\">// 接口回调处</span>\n<span class=\"hljs-keyword\">let</span> { count } = <span class=\"hljs-built_in\">this</span>.data\ndelele count[<span class=\"hljs-string\">`expireDate`</span>] <span class=\"hljs-comment\">// 删除原count中的expireDate</span>\n<span class=\"hljs-built_in\">this</span>.setData({\n  ...count,\n  <span class=\"hljs-attr\">expireDate</span>: newExpireDate\n})\n<span class=\"hljs-built_in\">this</span>.timer = <span class=\"hljs-built_in\">setInterval</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n  <span class=\"hljs-keyword\">let</span> expireDate = <span class=\"hljs-built_in\">this</span>.data.count.expireDate - <span class=\"hljs-number\">1</span>\n  <span class=\"hljs-built_in\">this</span>.setData({\n    <span class=\"hljs-attr\">count</span>: {\n      <span class=\"hljs-attr\">dayBegin</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">dayEnd</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">1</span>],\n      <span class=\"hljs-attr\">hourBegin</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">1</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">hourEnd</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">1</span>][<span class=\"hljs-number\">1</span>],\n      <span class=\"hljs-attr\">minuteBegin</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">2</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">minuteEnd</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">2</span>][<span class=\"hljs-number\">1</span>],\n      <span class=\"hljs-attr\">secondBegin</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">3</span>][<span class=\"hljs-number\">0</span>],\n      <span class=\"hljs-attr\">secondEnd</span>: <span class=\"hljs-built_in\">this</span>.convertTime(expireDate)[<span class=\"hljs-number\">3</span>][<span class=\"hljs-number\">1</span>],\n      expireDate,\n    }\n  })\n}, <span class=\"hljs-number\">1000</span>)\n\n<span class=\"hljs-comment\">/**\n * 时间转化函数，时间戳入参为秒\n*/</span>\n<span class=\"hljs-attr\">convertTime</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">sec</span>) </span>{\n  <span class=\"hljs-keyword\">let</span> time\n  <span class=\"hljs-keyword\">if</span> (sec &gt; -<span class=\"hljs-number\">1</span>) {\n    <span class=\"hljs-keyword\">let</span> hour = <span class=\"hljs-built_in\">Math</span>.floor(sec / <span class=\"hljs-number\">3600</span>)\n    <span class=\"hljs-keyword\">let</span> min = <span class=\"hljs-built_in\">Math</span>.floor(sec / <span class=\"hljs-number\">60</span>) % <span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> second = sec % <span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> day = <span class=\"hljs-built_in\">parseInt</span>(hour / <span class=\"hljs-number\">24</span>)\n    hour = hour - <span class=\"hljs-number\">24</span> * day\n    hour = hour &lt; <span class=\"hljs-number\">10</span> ? <span class=\"hljs-string\">`0<span class=\"hljs-subst\">${hour}</span>`</span> : hour\n    time = day &lt; <span class=\"hljs-number\">10</span> ? <span class=\"hljs-string\">`0<span class=\"hljs-subst\">${day}</span>:<span class=\"hljs-subst\">${hour}</span>:`</span>: <span class=\"hljs-string\">`<span class=\"hljs-subst\">${day}</span>:<span class=\"hljs-subst\">${hour}</span>:`</span>\n    <span class=\"hljs-keyword\">if</span> (min &lt; <span class=\"hljs-number\">10</span>) {\n      time += <span class=\"hljs-string\">&quot;0&quot;</span>\n    }\n    time += min + <span class=\"hljs-string\">&quot;:&quot;</span>;\n    <span class=\"hljs-keyword\">if</span> (second &lt; <span class=\"hljs-number\">10</span>) {\n      time += <span class=\"hljs-string\">&quot;0&quot;</span>\n    }\n    time += second\n    <span class=\"hljs-keyword\">return</span> time.split(<span class=\"hljs-string\">&#x27;:&#x27;</span>) <span class=\"hljs-comment\">// 返回一个包含天时分秒的数组</span>\n  }\n}\n<span class=\"hljs-comment\">// 最后不要忘记在周期销毁处清空计时器</span>\n<span class=\"hljs-attr\">onUnload</span>: <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) </span>{\n  <span class=\"hljs-built_in\">clearInterval</span>(<span class=\"hljs-built_in\">this</span>.timer)\n}\n</code></pre>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// 时间转 **前的函数</span>\n  getDateDiff: <span class=\"hljs-keyword\">function</span>(dateTimeStamp){\n    <span class=\"hljs-keyword\">let</span> result = &#x27;&#x27;\n    <span class=\"hljs-keyword\">let</span> minute = <span class=\"hljs-number\">1000</span><span class=\"hljs-operator\"> * </span><span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> hour = minute<span class=\"hljs-operator\"> * </span><span class=\"hljs-number\">60</span>\n    <span class=\"hljs-keyword\">let</span> day = hour<span class=\"hljs-operator\"> * </span><span class=\"hljs-number\">24</span>\n    <span class=\"hljs-keyword\">let</span> halfamonth = day<span class=\"hljs-operator\"> * </span><span class=\"hljs-number\">15</span>\n    <span class=\"hljs-keyword\">let</span> month = day<span class=\"hljs-operator\"> * </span><span class=\"hljs-number\">30</span>\n    <span class=\"hljs-keyword\">let</span> now = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-constructor\">Date()</span>.get<span class=\"hljs-constructor\">Time()</span>\n    <span class=\"hljs-keyword\">let</span> diffValue = now - dateTimeStamp\n    <span class=\"hljs-keyword\">if</span>(diffValue &lt; <span class=\"hljs-number\">0</span>) { return; }\n    <span class=\"hljs-keyword\">let</span> monthC = diffValue<span class=\"hljs-operator\"> / </span>month\n      <span class=\"hljs-keyword\">let</span> weekC = diffValue<span class=\"hljs-operator\"> / </span>(<span class=\"hljs-number\">7</span><span class=\"hljs-operator\"> * </span>day)\n      <span class=\"hljs-keyword\">let</span> dayC = diffValue<span class=\"hljs-operator\"> / </span>day\n      <span class=\"hljs-keyword\">let</span> hourC = diffValue<span class=\"hljs-operator\"> / </span>hour\n      <span class=\"hljs-keyword\">let</span> minC = diffValue<span class=\"hljs-operator\"> / </span>minute\n      <span class=\"hljs-keyword\">if</span>(monthC&gt;= <span class=\"hljs-number\">1</span>){\n    result = <span class=\"hljs-string\">&quot;&quot;</span> + parse<span class=\"hljs-constructor\">Int(<span class=\"hljs-params\">monthC</span>)</span> + <span class=\"hljs-string\">&quot;月前&quot;</span>\n    }\n      <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (weekC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">&quot;&quot;</span> + parse<span class=\"hljs-constructor\">Int(<span class=\"hljs-params\">weekC</span>)</span> + <span class=\"hljs-string\">&quot;周前&quot;</span>\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (dayC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">&quot;&quot;</span> + parse<span class=\"hljs-constructor\">Int(<span class=\"hljs-params\">dayC</span>)</span> + <span class=\"hljs-string\">&quot;天前&quot;</span>\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (hourC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">&quot;&quot;</span> + parse<span class=\"hljs-constructor\">Int(<span class=\"hljs-params\">hourC</span>)</span> + <span class=\"hljs-string\">&quot;小时前&quot;</span>\n    }\n    <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (minC &gt;= <span class=\"hljs-number\">1</span>) {\n      result = <span class=\"hljs-string\">&quot;&quot;</span> + parse<span class=\"hljs-constructor\">Int(<span class=\"hljs-params\">minC</span>)</span> + <span class=\"hljs-string\">&quot;分钟前&quot;</span>\n    } <span class=\"hljs-keyword\">else</span>\n      result = <span class=\"hljs-string\">&quot;刚刚&quot;</span>\n    return result\n  },\n</code></pre>\n<h3 id=\"最后\">最后</h3>\n<p>相关思路适用于所有mvvm框架。</p>\n"}