{"title":"小程序egg后台简要文档","description":"如果不需要后端java或者其他语言支持，对于小型的小程序后台，可以使用eggjs框架快速搭建简要的数据后台。","keywords":"mp,小程序,eggjs,微信开发后台","labels":["小程序"],"date":"2019-06-06","path":"2019/06/mp-egg.md","slug":"2019_06_mp-egg","html":"<p>如果不需要后端java或者其他语言支持，对于小型的小程序后台，可以使用eggjs框架快速搭建简要的数据后台。</p>\n<p>如果未接触过node编写接口，首先还是需要基本过一下<a target='_blank'  href=\"https://eggjs.org/zh-cn/intro/\">egg官方文档</a>，至少得把快速入门看完。</p>\n<p>不会从头开始把每一步都详细写下来，只针对微信对接的一些处理列出来。</p>\n<h2 id=\"数据库\">数据库</h2>\n<p>使用mongo，示例通过<a target='_blank'  href=\"https://github.com/eggjs/egg-mongoose\">egg-mongoose</a>进行连接处理。</p>\n<p>安装插件后，在<code>/config/plugin.js</code>进行基本配置：</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-attr\">mongoose:</span> {\n  <span class=\"hljs-attr\">enable:</span> <span class=\"hljs-literal\">true</span>,\n  <span class=\"hljs-attr\">package:</span> <span class=\"hljs-string\">&#x27;egg-mongoose&#x27;</span>\n}\n</code></pre>\n<p>在<code>/config/config.default.js</code>文件中配置mongodb的连接（保证本地测试环境数据库连接好）：</p>\n<pre><code class=\"language-javascript\">// connect mongo\n  config.mongoose = {\n    clien<span class=\"hljs-variable\">t:</span> {\n      ur<span class=\"hljs-variable\">l:</span> <span class=\"hljs-string\">&#x27;mongodb://127.0.0.1/fulishe&#x27;</span>,\n      option<span class=\"hljs-variable\">s:</span> {},\n    }\n  }\n</code></pre>\n<p>在<code>/app/models</code>文件夹编写相关的model，在程序运行时会自动在mongo上创建对应的表。也可以优先创建好数据库和表设计等。</p>\n<h2 id=\"编写接口\">编写接口</h2>\n<p>在<code>controller</code>写主要的业务逻辑，接受接口请求参数并返回。\n对于入参，需要进行验证的可以做验证处理，需要处理返回结果，即使请求出错也不要返回非200的状态码。\n可以将处理结果设置为一个函数，如：</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-comment\">// data: 返回给前端的数据，code: 状态，1为成功，0为失败，message：状态信息</span>\n<span class=\"hljs-symbol\">formatResponse:</span> <span class=\"hljs-meta\">function</span> (<span class=\"hljs-meta\">data</span>, <span class=\"hljs-meta\">code</span>, message) {\n  return {\n    <span class=\"hljs-meta\">code</span>,\n    <span class=\"hljs-meta\">data</span>,\n    message\n  }\n}\n</code></pre>\n<p>!&gt; 为避免出现出现问题而导致程序中断，最好在每一个容易出现问题的地方进行<code>try catch</code>将异常抛出并返回到前端。</p>\n<p>在<code>service</code>编写数据库操作函数等，通过在<code>controller</code>进行调用，统一管理数据库数据进出。\n注意在数据新增的时候需要进行<code>save</code>操作：</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-keyword\">const</span> addUser = await <span class=\"hljs-keyword\">this</span>.ctx.model.Users(<span class=\"hljs-keyword\">data</span>)\naddUser.save() <span class=\"hljs-comment\">// 不要遗漏</span>\n</code></pre>\n<p>相关的增删改查操作，需要直接点的可以看仓库<code>app/service</code>下的写法。</p>\n<h2 id=\"小程序接口相关\">小程序接口相关</h2>\n<p>以下是eggjs对小程序包括获取openId、获取unionId、获取手机号码、判断用户是否关注公众号、客服信息发送进行编写说明。<br>如果某个对象不知道是什么，一般都是可以根据名字找到对于的js文件或者通过npm引入，不再表述引入什么了。</p>\n<h3 id=\"获取openid\">获取openId</h3>\n<p>参数说明：</p>\n<ul>\n<li>APPID： 小程序的appId</li>\n<li>SECRET： 小程序的secret，跟appId在同一个地方能找到</li>\n<li>CODE：小程序在前端通过wx.login()获取的jscode</li>\n</ul>\n<pre><code class=\"language-javascript\">const openIdRes = await rp(`https:<span class=\"hljs-regexp\">//</span>api.weixin.qq.com<span class=\"hljs-regexp\">/sns/</span>jscode2session?appid=<span class=\"hljs-variable\">${APPID}</span>&amp;secret=<span class=\"hljs-variable\">${SECRET}</span>&amp;js_code=<span class=\"hljs-variable\">${CODE}</span>&amp;grant_type=authorization_code`)\nconst openId = JSON.parse(openIdRes).openId <span class=\"hljs-regexp\">//</span> 在处理错误判断后，返回的数据是json字符串，需要转化\n</code></pre>\n<h3 id=\"获取unionid\">获取unionId</h3>\n<p>unionId，属于微信端通用的账号唯一标识，举个例子就是同一个微信号，唯一对应一个unionId。而在每一个小程序上，用户openId都不一样。可以用于判断在小程序上的用户是否关注公众号等。</p>\n<p>在第一个获取<code>openId</code>的时候，会返回<code>openId</code>以及<code>session_key</code>，通过小程序前端传过来的<code>encryptedData</code>以及<code>iv</code>就可以拿到<code>unionId</code>。</p>\n<p>参数说明：</p>\n<ul>\n<li>APPID： 小程序的appId</li>\n<li>sessionKey：获取openId的时候，一并返回了sessionKey</li>\n<li>encryptedData：小程序在前端通过获取用户信息返回</li>\n<li>iv：小程序在前端通过获取用户信息返回</li>\n</ul>\n<pre><code class=\"language-javascript\">const pc = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-constructor\">WXBizDataCrypt(APPID, <span class=\"hljs-params\">sessionKey</span>)</span>\nconst data = pc.decrypt<span class=\"hljs-constructor\">Data(<span class=\"hljs-params\">encryptedData</span>, <span class=\"hljs-params\">iv</span>)</span>\nconst unionId = data.unionId\n</code></pre>\n<h3 id=\"获取手机号码\">获取手机号码</h3>\n<p>获取手机号码的步骤跟获取unionId一样。</p>\n<p>只需要注意的是，<code>encryptedData</code>、<code>iv</code>是在小程序端通过<code>getPhoneNumber</code>获取。</p>\n<h3 id=\"判断用户是否关注公众号\">判断用户是否关注公众号</h3>\n<p>这里单独在小程序后台无法判断。需要在对于的公众号后台提供一个接口用于判断该unionId是否已经关注了公众号。</p>\n<h3 id=\"客服信息发送\">客服信息发送</h3>\n<p>在小程序开发设置中配置消息推送。</p>\n<p>配置参考： </p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>值</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>URL(服务器地址)</td>\n<td>https://<em>.</em>.com/message/check</td>\n<td>微信那边与你服务器通信的接口</td>\n</tr>\n<tr>\n<td>Token(令牌)</td>\n<td>isToken</td>\n<td>自定义</td>\n</tr>\n<tr>\n<td>EncodingAESKey(消息加密密钥)</td>\n<td>******</td>\n<td>填写那可以自动生成</td>\n</tr>\n<tr>\n<td>消息加密方式</td>\n<td>兼容模式</td>\n<td>涉及信息安全</td>\n</tr>\n<tr>\n<td>数据格式</td>\n<td>JSON</td>\n<td>一般是这个吧</td>\n</tr>\n</tbody></table>\n<p>在<code>controller</code>层编写一个<code>get</code>接口，对应<code>/message/check</code>，用以给微信进行服务器验证。\n完整验证函数接口可如下：</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-title\">index</span>(<span class=\"hljs-params\"></span>)</span> {\n  <span class=\"hljs-keyword\">const</span> { ctx } = <span class=\"hljs-keyword\">this</span>\n  <span class=\"hljs-comment\">// 1.获取微信服务器Get请求的参数 signature、timestamp、nonce、echostr</span>\n  <span class=\"hljs-keyword\">const</span> {\n    signature,\n    timestamp,\n    nonce,\n    echostr\n  } = ctx.query\n\n  <span class=\"hljs-comment\">// 2.将token、timestamp、nonce三个参数进行字典序排序</span>\n  <span class=\"hljs-keyword\">let</span> array = [<span class=\"hljs-string\">&#x27;线上配置的令牌&#x27;</span>, timestamp, nonce]\n  array.sort() <span class=\"hljs-comment\">// JavaScript sort函数就是字典序排序的</span>\n\n  <span class=\"hljs-comment\">// 3.将三个参数字符串拼接成一个字符串进行sha1加密</span>\n  <span class=\"hljs-keyword\">const</span> tempStr = array.<span class=\"hljs-keyword\">join</span>(<span class=\"hljs-string\">&#x27;&#x27;</span>)\n  <span class=\"hljs-keyword\">const</span> hashCode = crypto.createHash(<span class=\"hljs-string\">&#x27;sha1&#x27;</span>) <span class=\"hljs-comment\">//创建加密类型</span>\n  <span class=\"hljs-keyword\">const</span> resultCode = hashCode.update(tempStr, <span class=\"hljs-string\">&#x27;utf8&#x27;</span>).digest(<span class=\"hljs-string\">&#x27;hex&#x27;</span>)\n\n  <span class=\"hljs-comment\">// 4.开发者获得加密后的字符串可与signature对比，标识该请求来源于微信</span>\n  <span class=\"hljs-keyword\">if</span> (resultCode === signature) {\n    ctx.body = echostr\n  } <span class=\"hljs-keyword\">else</span> {\n    <span class=\"hljs-comment\">// 非微信服务器请求</span>\n    ctx.body = format.formatResponse({\n      resultCode,\n      req: ctx.query\n    }, <span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">&#x27;验证失败1&#x27;</span>)\n  }\n}\n</code></pre>\n<p>自动回复操作：\n在<code>controller</code>层编写一个<code>post</code>接口，对应<code>/message/check</code>，用于自动回复。\n完整处理自动回复接口：</p>\n<pre><code class=\"language-javascript\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-function\"><span class=\"hljs-title\">handle</span>(<span class=\"hljs-params\"></span>)</span> {\n  <span class=\"hljs-keyword\">const</span> { ctx } = <span class=\"hljs-built_in\">this</span>\n  <span class=\"hljs-keyword\">const</span> { FromUserName, MsgType, Content } = ctx.request.body <span class=\"hljs-comment\">// 这是从微信转发过来的用户发送的信息参数</span>\n  <span class=\"hljs-keyword\">const</span> { openid } = ctx.query\n  <span class=\"hljs-comment\">// 获取accessToken</span>\n  <span class=\"hljs-keyword\">const</span> tokenRes = <span class=\"hljs-keyword\">await</span> rp(<span class=\"hljs-string\">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class=\"hljs-subst\">${CONST.appId}</span>&amp;secret=<span class=\"hljs-subst\">${CONST.secret}</span>`</span>)\n  <span class=\"hljs-keyword\">if</span> (!(<span class=\"hljs-string\">&#x27;errcode&#x27;</span> <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">JSON</span>.parse(tokenRes))) {\n    <span class=\"hljs-keyword\">if</span> (MsgType === <span class=\"hljs-string\">&#x27;text&#x27;</span>) {\n      <span class=\"hljs-keyword\">const</span> postData = {\n        <span class=\"hljs-attr\">touser</span>: openid,\n        <span class=\"hljs-attr\">msgtype</span>: <span class=\"hljs-string\">&quot;link&quot;</span>,\n        <span class=\"hljs-attr\">link</span>: {\n          <span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">&#x27;链接标题&#x27;</span>,\n          <span class=\"hljs-attr\">description</span>: <span class=\"hljs-string\">&#x27;链接描述&#x27;</span>,\n          <span class=\"hljs-attr\">url</span>: <span class=\"hljs-string\">&#x27;链接&#x27;</span>,\n          <span class=\"hljs-attr\">thumb_url</span>: <span class=\"hljs-string\">&#x27;链接封面图&#x27;</span>\n        }\n      }\n      <span class=\"hljs-keyword\">const</span> sendRes = <span class=\"hljs-keyword\">await</span> rp({\n        <span class=\"hljs-attr\">uri</span>: <span class=\"hljs-string\">`https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=<span class=\"hljs-subst\">${<span class=\"hljs-built_in\">JSON</span>.parse(tokenRes).access_token}</span>`</span>,\n        <span class=\"hljs-attr\">method</span>: <span class=\"hljs-string\">&#x27;post&#x27;</span>,\n        <span class=\"hljs-attr\">body</span>: postData,\n        <span class=\"hljs-attr\">json</span>: <span class=\"hljs-literal\">true</span>\n      })\n    }\n  }\n  ctx.body = <span class=\"hljs-string\">&#x27;success&#x27;</span>\n}\n</code></pre>\n<p>!&gt; 注意：需要在自动回复的最后返回<code>success</code>，否则会在聊天窗口看到提示：<code>该小程序提供的服务出现故障，请稍后再试</code></p>\n"}